<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Social Dashboard</title>
<style>
body{font-family:sans-serif;background:#f5f5f5;color:#333;margin:0;padding:20px;}
h1{color:#2962FF;}
table{border-collapse:collapse;width:100%;margin-top:10px;}
th,td{border:1px solid #ccc;padding:8px;text-align:left;}
th{background:#eee;}
.screenshot-thumbnail{width:50px;height:auto;}
#filters{margin-bottom:15px;}
#filters label{margin-right:5px;}
#filters select,#filters input{margin-right:15px;}
button{padding:5px 10px;margin-right:5px;cursor:pointer;}
#tableContainer{margin-top:20px;}
.active{display:block;}
#errorMsg{color:red;margin-top:10px;}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>Social Dashboard</h1>

<div id="filters">
    <label>Start Date: <input type="date" id="dateStartFilter"></label>
    <label>End Date: <input type="date" id="dateEndFilter"></label>
    <label>Sector: <select id="sectorFilter"><option value="">All Sectors</option></select></label>
    <label>Goal: <select id="goalFilter"><option value="">All Goals</option></select></label>
    <button id="resetFiltersBtn">Reset Filters</button>
</div>

<div id="errorMsg"></div>
<div id="fileInfo"></div>

<div id="tableContainer" class="active">
    <table>
        <thead>
            <tr><th>Site</th><th>Date</th><th>Sector</th><th>Goal</th><th>Screenshot</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
    <div id="pagination">
        <button id="prevBtn">Prev</button>
        <button id="nextBtn">Next</button>
        <input type="text" id="pageJump" placeholder="Go to page" style="width:70px;">
        <span id="pageInfo"></span>
    </div>
</div>

<h2>Charts</h2>
<canvas id="allSectorsChart" width="400" height="200"></canvas>
<canvas id="top5SectorsBarChart" width="400" height="200"></canvas>
<canvas id="goalsPieChart" width="400" height="200"></canvas>

<script>
// ======== CSV PARSER ========
function parseCSVLine(line, delim) {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];

        if (char === '"') {
            if (inQuotes && nextChar === '"') {
                current += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (char === delim && !inQuotes) {
            result.push(current.trim());
            current = '';
        } else if (char !== '\r') {
            current += char;
        }
    }
    result.push(current.trim());
    return result;
}

// ======== GLOBALS ========
let currentData = [];
let filteredData = [];
let currentPage = 1;
const rowsPerPage = 15;
const colors = [
    '#2962FF','#F44336','#4CAF50','#FF9800','#9C27B0','#00BCD4','#E91E63','#8BC34A',
    '#FFC107','#795548','#607D8B','#CDDC39','#FF5722','#009688','#673AB7'
];

let allSectorsChart, top5SectorsBarChart, goalsPieChart;

// ======== DATE PARSER ========
function parseItalianDate(val) {
    if (!val) return '';
    const parts = val.split('/');
    if (parts.length === 3) {
        return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
    }
    return val;
}

function formatDateForDisplay(isoDate) {
    if (!isoDate || isoDate.length < 10) return '-';
    const parts = isoDate.split(' ');
    const datePart = parts[0];
    const timePart = parts[1] || '';
    const dateParts = datePart.split('-');
    if (dateParts.length === 3) {
        const formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
        return timePart ? `${formattedDate} ${timePart}` : formattedDate;
    }
    return isoDate;
}

// ======== CSV FILE HANDLER ========
function handleFile(file) {
    const reader = new FileReader();
    const errorMsg = document.getElementById('errorMsg');
    const fileInfo = document.getElementById('fileInfo');
    const delimiter = ';';

    reader.onload = () => {
        try {
            const text = reader.result;
            const lines = text.split('\n').filter(l => l.trim() !== '');
            if (!lines.length) throw new Error('CSV vuoto');

            const headers = parseCSVLine(lines[0], delimiter);

            let siteIdx = -1, dateIdx = -1, sectorIdx = -1, goalIdx = -1, screenshotIdx = -1;
            headers.forEach((h, i) => {
                const lower = h.toLowerCase().trim();
                if (lower.includes('site') || lower.includes('sito') || lower.includes('url')) siteIdx = i;
                if (lower.includes('last') || lower.includes('date') || lower.includes('data') || lower.includes('seen')) dateIdx = i;
                if (lower.includes('sector') && lower.includes('attack')) sectorIdx = i;
                if (lower.includes('goal') || lower.includes('obiettivo')) goalIdx = i;
                if (lower.includes('screenshot') || lower.includes('image') || lower.includes('foto')) screenshotIdx = i;
            });

            if (siteIdx === -1 || sectorIdx === -1 || goalIdx === -1) {
                errorMsg.innerHTML = `⚠️ Columns not found:<br>${headers.map((h,i)=>`${i}: "${h}"`).join('<br>')}`;
                return;
            }

            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i], delimiter);

                let sector = values[sectorIdx] || 'UNKNOWN';
                let goal = values[goalIdx] || 'UNKNOWN';

                if (sector.startsWith('http') || sector.includes('://') || sector.includes('drive.google')) sector = 'UNKNOWN';
                if (goal.startsWith('http') || goal.includes('://') || goal.includes('drive.google')) goal = 'UNKNOWN';

                if (values[siteIdx] && values[siteIdx].length > 0) {
                    const rowData = {
                        site: values[siteIdx] || '',
                        date: dateIdx !== -1 ? parseItalianDate(values[dateIdx]) : '',
                        sector: sector.trim().toUpperCase(),
                        goal: goal.trim().toUpperCase(),
                        screenshot: screenshotIdx !== -1 ? values[screenshotIdx] : '',
                        rowIndex: i
                    };
                    data.push(rowData);
                }
            }

            currentData = data;
            filteredData = data;

            fileInfo.textContent = `✓ Loaded ${data.length} records`;
            document.getElementById('tableContainer').classList.add('active');

            populateFilters(data);
            displayPage(filteredData, 1);
            updateAllCharts(filteredData);

        } catch (error) {
            errorMsg.textContent = '⚠️ Error: ' + error.message;
        }
    };

    reader.onerror = () => { errorMsg.textContent = '⚠️ Error reading file'; };
    reader.readAsText(file);
}

// ======== FILTERS ========
document.getElementById('dateStartFilter').addEventListener('change', applyFilters);
document.getElementById('dateEndFilter').addEventListener('change', applyFilters);
document.getElementById('sectorFilter').addEventListener('change', applyFilters);
document.getElementById('goalFilter').addEventListener('change', applyFilters);
document.getElementById('resetFiltersBtn').addEventListener('click', function() {
    document.getElementById('dateStartFilter').value='';
    document.getElementById('dateEndFilter').value='';
    document.getElementById('sectorFilter').value='';
    document.getElementById('goalFilter').value='';
    applyFilters();
});

function applyFilters() {
    const dateStart = document.getElementById('dateStartFilter').value;
    const dateEnd = document.getElementById('dateEndFilter').value;
    const sectorFilter = document.getElementById('sectorFilter').value;
    const goalFilter = document.getElementById('goalFilter').value;

    filteredData = currentData.filter(r => {
        if (dateStart && r.date < dateStart) return false;
        if (dateEnd && r.date > dateEnd) return false;
        if (sectorFilter && r.sector !== sectorFilter) return false;
        if (goalFilter && r.goal !== goalFilter) return false;
        return true;
    });

    displayPage(filteredData, 1);
    updateAllCharts(filteredData);
}

function populateFilters(data) {
    const sectors = [...new Set(data.map(r=>r.sector))].sort();
    const sectorSelect=document.getElementById('sectorFilter');
    sectorSelect.innerHTML='<option value="">All Sectors</option>';
    sectors.forEach(s=>{ const o=document.createElement('option'); o.value=s;o.textContent=s;sectorSelect.appendChild(o);});

    const goals = [...new Set(data.map(r=>r.goal))].sort();
    const goalSelect=document.getElementById('goalFilter');
    goalSelect.innerHTML='<option value="">All Goals</option>';
    goals.forEach(g=>{ const o=document.createElement('option'); o.value=g;o.textContent=g;goalSelect.appendChild(o);});
}

// ======== PAGINATION ========
document.getElementById('prevBtn').onclick = () => { if(currentPage>1){currentPage--;displayPage(filteredData,currentPage);} };
document.getElementById('nextBtn').onclick = () => { const total=Math.ceil(filteredData.length/rowsPerPage); if(currentPage<total){currentPage++;displayPage(filteredData,currentPage);} };
document.getElementById('pageJump').addEventListener('keypress', function(e){ if(e.key==='Enter'){ const pageNum=parseInt(this.value); const total=Math.ceil(filteredData.length/rowsPerPage); if(pageNum>=1 && pageNum<=total){displayPage(filteredData,pageNum);} else {alert(`⚠️ Pagina non valida! Inserisci un numero tra 1 e ${total}`);} this.value='';} });

function displayPage(data,page){
    currentPage=page;
    const tbody=document.getElementById('tableBody');
    tbody.innerHTML='';
    const start=(page-1)*rowsPerPage;
    const pageData=data.slice(start,start+rowsPerPage);
    if(!pageData.length){tbody.innerHTML='<tr><td colspan="5" style="text-align:center;color:#8b95a5;">No data found</td></tr>';return;}

    pageData.forEach(r=>{
        const siteDisplay=r.site.length>50?r.site.substring(0,47)+'...':r.site;
        const dateDisplay=r.date?formatDateForDisplay(r.date):'-';
        const screenshotCell=r.screenshot?`<img src="${r.screenshot}" class="screenshot-thumbnail">`:'-';
        tbody.innerHTML+=`<tr>
            <td title="${r.site}">${siteDisplay}</td>
            <td>${dateDisplay}</td>
            <td>${r.sector}</td>
            <td>${r.goal}</td>
            <td>${screenshotCell}</td>
        </tr>`;
    });

    const total=Math.ceil(data.length/rowsPerPage)||1;
    document.getElementById('pageInfo').textContent=`Page ${page} of ${total} (${data.length} records)`;
    document.getElementById('prevBtn').disabled=page===1;
    document.getElementById('nextBtn').disabled=page===total;
}

// ======== CHARTS ========
function updateAllCharts(data){
    const sectorCounts = {};
    const goalCounts = {};
    data.forEach(r=>{
        sectorCounts[r.sector] = (sectorCounts[r.sector]||0)+1;
        goalCounts[r.goal] = (goalCounts[r.goal]||0)+1;
    });

    const sectorLabels = Object.keys(sectorCounts);
    const sectorData = Object.values(sectorCounts);

    const goalLabels = Object.keys(goalCounts);
    const goalData = Object.values(goalCounts);

    if(allSectorsChart) allSectorsChart.destroy();
    allSectorsChart = new Chart(document.getElementById('allSectorsChart'),{
        type:'pie',
        data:{labels:sectorLabels,datasets:[{data:sectorData,backgroundColor:colors}]}
    });

    if(top5SectorsBarChart) top5SectorsBarChart.destroy();
    const top5 = Object.entries(sectorCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
    top5SectorsBarChart = new Chart(document.getElementById('top5SectorsBarChart'),{
        type:'bar',
        data:{
            labels:top5.map(a=>a[0]),
            datasets:[{label:'Top 5 Sectors',data:top5.map(a=>a[1]),backgroundColor:colors.slice(0,5)}]
        }
    });

    if(goalsPieChart) goalsPieChart.destroy();
    goalsPieChart = new Chart(document.getElementById('goalsPieChart'),{
        type:'pie',
        data:{labels:goalLabels,datasets:[{data:goalData,backgroundColor:colors}]}
    });
}

// ======== AUTO LOAD CSV ========
document.addEventListener('DOMContentLoaded', function(){
    const csvPath='/social-dashboard/data/dati.csv';
    fetch(csvPath)
        .then(r=>{if(!r.ok)throw new Error('CSV file not found'); return r.text();})
        .then(text=>{ const file=new File([text],'dati.csv',{type:'text/csv'}); handleFile(file); })
        .catch(err=>{console.warn('⚠️ Auto-load fallito: '+err.message);});
});
</script>
</body>
</html>
