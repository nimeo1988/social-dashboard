<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Social Engineering Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Roboto+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* === STILI IDENTICI AI TUOI (NON TOCCATI) === */
body { font-family: 'Rajdhani', sans-serif; background:#1a1d35; color:#fff }
.container { max-width:1200px; margin:auto; padding:20px }
.search-box { padding:12px; background:#2c2f4d; color:#fff; border-radius:8px }
.upload-btn { padding:12px 24px; background:#2962FF; color:#fff; border:none; border-radius:8px; cursor:pointer }
.table-container { background:#22253a; padding:20px; border-radius:12px; margin-top:20px }
table { width:100%; border-collapse:collapse }
th,td { padding:10px; border-bottom:1px solid #333 }
th { background:#1a1d35 }
.screenshot-thumbnail { width:80px; cursor:pointer }
.pagination { margin:20px 0; text-align:center }
</style>
</head>

<body>
<div class="container">

<h1>SOCIAL ENGINEERING DASHBOARD</h1>

<input type="file" id="fileInput" accept=".csv">

<div class="table-container" id="tableContainer" style="display:none">

<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:10px;margin-bottom:10px">
<input type="date" id="dateStartFilter" class="search-box">
<input type="date" id="dateEndFilter" class="search-box">

<select id="sectorFilter" class="search-box">
<option value="">All Sectors</option>
</select>

<select id="goalFilter" class="search-box">
<option value="">All Goals</option>
</select>

<button id="resetFiltersBtn" class="upload-btn">Reset</button>
</div>

<button id="generatePdfBtn" class="upload-btn" style="background:#27ae60">Generate PDF</button>

<table>
<thead>
<tr>
<th>Site</th>
<th>Date</th>
<th>Sector</th>
<th>Goal</th>
<th>Screenshot</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<div class="pagination">
<button id="prevBtn">Prev</button>
<span id="pageInfo"></span>
<button id="nextBtn">Next</button>
</div>
</div>
</div>

<script>
/* ===================== VARIABILI ===================== */
let currentData = [];
let filteredData = [];
let currentPage = 1;
const rowsPerPage = 10;

/* ===================== DATE PARSER ===================== */
function parseDateSafe(dateStr) {
    if (!dateStr) return null;

    if (dateStr.includes('-')) {
        return new Date(dateStr.substring(0, 10));
    }
    if (dateStr.includes('/')) {
        const [d,m,y] = dateStr.split('/');
        return new Date(`${y}-${m}-${d}`);
    }
    return null;
}

/* ===================== FILE UPLOAD ===================== */
document.getElementById('fileInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if(file) handleFile(file);
});

function handleFile(file){
    const reader = new FileReader();
    reader.onload = e => parseCSV(e.target.result);
    reader.readAsText(file);
}

function parseCSV(text){
    const lines = text.split('\n').filter(l => l.trim());
    const headers = lines[0].split(',');

    let siteIdx=-1, dateIdx=-1, sectorIdx=-1, goalIdx=-1, screenshotIdx=-1;

    headers.forEach((h,i)=>{
        const l=h.toLowerCase();
        if(l.includes('site')||l.includes('url')) siteIdx=i;
        if(l.includes('date')||l.includes('seen')) dateIdx=i;
        if(l.includes('sector')) sectorIdx=i;
        if(l.includes('goal')||l.includes('obiettivo')||l.includes('pretext')) goalIdx=i;
        if(l.includes('screenshot')||l.includes('image')) screenshotIdx=i;
    });

    const data=[];
    for(let i=1;i<lines.length;i++){
        const v=lines[i].split(',');
        data.push({
            site:v[siteIdx]||'',
            date:v[dateIdx]||'',
            sector:(v[sectorIdx]||'UNKNOWN').toUpperCase(),
            goal:(v[goalIdx]||'UNKNOWN').toUpperCase(),
            screenshot:v[screenshotIdx]||''
        });
    }

    currentData=data;
    filteredData=data;

    populateFilters(data);
    document.getElementById('tableContainer').style.display='block';
    displayPage(filteredData,1);
}

/* ===================== FILTRI ===================== */
['dateStartFilter','dateEndFilter','sectorFilter','goalFilter']
.forEach(id=>document.getElementById(id).addEventListener('change',applyFilters));

document.getElementById('resetFiltersBtn').onclick=()=>{
    dateStartFilter.value='';
    dateEndFilter.value='';
    sectorFilter.value='';
    goalFilter.value='';
    applyFilters();
};

function applyFilters(){
    const ds=dateStartFilter.value?new Date(dateStartFilter.value):null;
    const de=dateEndFilter.value?new Date(dateEndFilter.value):null;

    filteredData=currentData.filter(r=>{
        const rd=parseDateSafe(r.date);
        if(ds&&rd&&rd<ds) return false;
        if(de&&rd&&rd>de) return false;
        if(sectorFilter.value && !r.sector.includes(sectorFilter.value)) return false;
        if(goalFilter.value && !r.goal.includes(goalFilter.value)) return false;
        return true;
    });

    displayPage(filteredData,1);
}

/* ===================== PAGINAZIONE ===================== */
function displayPage(data,page){
    currentPage=page;
    const tbody=document.getElementById('tableBody');
    tbody.innerHTML='';

    const start=(page-1)*rowsPerPage;
    const slice=data.slice(start,start+rowsPerPage);

    slice.forEach(r=>{
        tbody.innerHTML+=`
        <tr>
            <td>${r.site}</td>
            <td>${r.date}</td>
            <td>${r.sector}</td>
            <td>${r.goal}</td>
            <td>${r.screenshot||'-'}</td>
        </tr>`;
    });

    const total=Math.max(1,Math.ceil(data.length/rowsPerPage));
    pageInfo.textContent=`Page ${page} of ${total}`;
    prevBtn.disabled=page===1;
    nextBtn.disabled=page===total;
}

prevBtn.onclick=()=>currentPage>1&&displayPage(filteredData,--currentPage);
nextBtn.onclick=()=>displayPage(filteredData,++currentPage);

/* ===================== FILTRI SELECT ===================== */
function populateFilters(data){
    const sectors=[...new Set(data.map(r=>r.sector))];
    sectorFilter.innerHTML='<option value="">All Sectors</option>';
    sectors.forEach(s=>sectorFilter.innerHTML+=`<option>${s}</option>`);

    const goals=[...new Set(data.map(r=>r.goal))];
    goalFilter.innerHTML='<option value="">All Goals</option>';
    goals.forEach(g=>goalFilter.innerHTML+=`<option>${g}</option>`);
}

/* ===================== PDF ===================== */
generatePdfBtn.onclick=()=>{
    const {jsPDF}=window.jspdf;
    const pdf=new jsPDF();
    pdf.text(`Records: ${filteredData.length}`,20,20);
    pdf.save('report.pdf');
};
</script>
</body>
</html>