<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Social Engineering Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Roboto+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
/* (Mantieni tutto il CSS della tua versione precedente) */
body { font-family: 'Rajdhani', sans-serif; background: #1a1d35; color: #fff; line-height: 1.6; }
.container { max-width: 1200px; margin: 0 auto; padding: 20px; }
header { text-align:center; margin-bottom:30px; }
h1 { font-size:2.5rem; margin:0; letter-spacing:3px; font-weight:700; }
.subtitle { color:#8b95a5; font-size:1.1rem; margin-top:10px; letter-spacing:1px; }
/* Resto del CSS... puoi copiare tutto dalla tua versione */
</style>
</head>

<body>
<div class="container">

<header>
    <h1>SOCIAL ENGINEERING DASHBOARD</h1>
    <div class="subtitle">Phishing Sites & Human Attack Surface</div>
</header>

<div class="upload-section">
    <h2>UPLOAD XLSX / CSV</h2>
    <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üìä</div>
        <p>Click to upload XLSX/CSV file</p>
        <p style="color:#8b95a5">or drag & drop here</p>
        <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx,.xls,.txt">
    </div>
    <div id="fileInfo" class="file-info"></div>
    <div id="errorMsg" class="error-msg"></div>
</div>

<div class="table-container" id="tableContainer">
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr 100px;gap:1rem;margin-bottom:1rem;">
        <div class="date-input-wrapper">
            <input type="date" id="dateStartFilter" class="search-box" placeholder="Start Date">
        </div>
        <div class="date-input-wrapper">
            <input type="date" id="dateEndFilter" class="search-box" placeholder="End Date">
        </div>
        <select id="sectorFilter" class="search-box" style="cursor:pointer;">
            <option value="">All Sectors</option>
        </select>
        <select id="goalFilter" class="search-box" style="cursor:pointer;">
            <option value="">All Goals</option>
        </select>
        <button id="resetFiltersBtn" class="upload-btn" style="background:#e74c3c;">üîÑ Reset</button>
    </div>
    
    <div style="text-align:center;margin-bottom:1.5rem;">
        <button id="generatePdfBtn" class="upload-btn" style="background:#27ae60;">üìÑ Generate PDF Report</button>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Site</th>
                <th>Date</th>
                <th>Sector</th>
                <th>Goal</th>
                <th>Screenshot</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="5" style="text-align:center;color:#8b95a5;">No data loaded</td></tr>
        </tbody>
    </table>
    <div class="pagination">
        <button id="prevBtn">‚Üê Previous</button>
        <span id="pageInfo">Page 1</span>
        <button id="nextBtn">Next ‚Üí</button>
    </div>
</div>

<div id="imageModal" class="modal" onclick="closeModal()">
    <span class="close">&times;</span>
    <img class="modal-content" id="modalImage">
</div>

<!-- Canvas nascosti per PDF -->
<canvas id="pdfBarChart" style="position:absolute;left:-9999px;top:-9999px;"></canvas>
<canvas id="pdfLineChart" style="position:absolute;left:-9999px;top:-9999px;"></canvas>
<canvas id="pdfMultiLineChart" style="position:absolute;left:-9999px;top:-9999px;"></canvas>

<script>
let currentData = [];
let filteredData = [];
let currentPage = 1;
const rowsPerPage = 10;
const colors=['#5a8db8','#e74c3c','#e67e22','#7b8794','#3498db','#9b59b6','#27ae60','#f39c12','#c0392b','#16a085','#8e44ad','#2c3e50','#e67e22','#95a5a6','#34495e'];

const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const fileInfo = document.getElementById('fileInfo');
const errorMsg = document.getElementById('errorMsg');

uploadArea.onclick = () => fileInput.click();

uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
uploadArea.addEventListener('drop', e => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});

fileInput.addEventListener('change', e => { if(e.target.files.length) handleFile(e.target.files[0]); });

function getGitHubImagePath(filename) {
    if(!filename) return '';
    return `https://raw.githubusercontent.com/nimeo1988/social-dasboard/main/images/${filename}`;
}

function showImage(imagePath) {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    modal.style.display = 'flex';
    modalImg.src = imagePath;
}

function closeModal() {
    document.getElementById('imageModal').style.display = 'none';
}

async function handleFile(file){
    errorMsg.textContent = '';
    fileInfo.textContent = `üìÅ Loading ${file.name}...`;

    try {
        let dataRows = [];

        if(file.name.endsWith('.xlsx') || file.name.endsWith('.xls')){
            const arrayBuffer = await file.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, {type:"array"});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            dataRows = XLSX.utils.sheet_to_json(firstSheet, {defval:""});
        } else {
            // CSV fallback
            const text = await file.text();
            const lines = text.split('\n').filter(l => l.trim());
            const headers = lines[0].split(/,|\t/).map(h => h.trim());
            dataRows = lines.slice(1).map(l => {
                const vals = l.split(/,|\t/);
                const obj = {};
                headers.forEach((h,i)=>obj[h]=vals[i]||"");
                return obj;
            });
        }

        if(dataRows.length === 0){
            errorMsg.textContent = '‚ö†Ô∏è File is empty';
            return;
        }

        currentData = dataRows.map(row => ({
            site: row.Site || row.URL || "",
            date: row.Date || "",
            sector: (row.Sector || "UNKNOWN").toUpperCase(),
            goal: (row.Goal || "UNKNOWN").toUpperCase(),
            screenshot: row.Screenshot || row.Image || ""
        }));

        filteredData = [...currentData];

        fileInfo.textContent = `‚úì Loaded ${currentData.length} records`;
        document.getElementById('tableContainer').classList.add('active');

        populateFilters(currentData);
        displayPage(filteredData,1);

    } catch(err){
        console.error(err);
        errorMsg.textContent = '‚ö†Ô∏è Error reading file';
    }
}

function populateFilters(data){
    const sectors = [...new Set(data.map(r=>r.sector))].sort();
    const sectorSelect = document.getElementById('sectorFilter');
    sectorSelect.innerHTML = '<option value="">All Sectors</option>';
    sectors.forEach(s => { const o=document.createElement('option'); o.value=o.textContent=s; sectorSelect.appendChild(o); });

    const goals = [...new Set(data.map(r=>r.goal))].sort();
    const goalSelect = document.getElementById('goalFilter');
    goalSelect.innerHTML = '<option value="">All Goals</option>';
    goals.forEach(g => { const o=document.createElement('option'); o.value=o.textContent=g; goalSelect.appendChild(o); });
}

document.getElementById('sectorFilter').addEventListener('change', applyFilters);
document.getElementById('goalFilter').addEventListener('change', applyFilters);
document.getElementById('dateStartFilter').addEventListener('change', applyFilters);
document.getElementById('dateEndFilter').addEventListener('change', applyFilters);

document.getElementById('resetFiltersBtn').addEventListener('click', () => {
    document.getElementById('sectorFilter').value='';
    document.getElementById('goalFilter').value='';
    document.getElementById('dateStartFilter').value='';
    document.getElementById('dateEndFilter').value='';
    applyFilters();
});

function applyFilters(){
    const sectorF = document.getElementById('sectorFilter').value;
    const goalF = document.getElementById('goalFilter').value;
    const dateStart = document.getElementById('dateStartFilter').value;
    const dateEnd = document.getElementById('dateEndFilter').value;

    filteredData = currentData.filter(r=>{
        if(sectorF && r.sector!==sectorF) return false;
        if(goalF && r.goal!==goalF) return false;
        if(dateStart && r.date<dateStart) return false;
        if(dateEnd && r.date>dateEnd) return false;
        return true;
    });
    displayPage(filteredData,1);
}

document.getElementById('prevBtn').addEventListener('click',()=>{ if(currentPage>1){ currentPage--; displayPage(filteredData,currentPage); }});
document.getElementById('nextBtn').addEventListener('click',()=>{ const total=Math.ceil(filteredData.length/rowsPerPage); if(currentPage<total){ currentPage++; displayPage(filteredData,currentPage); }});

function displayPage(data,page){
    currentPage=page;
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML='';
    const start=(page-1)*rowsPerPage;
    const pageData=data.slice(start,start+rowsPerPage);

    if(pageData.length===0){ tbody.innerHTML='<tr><td colspan="5" style="text-align:center;color:#8b95a5;">No data found</td></tr>'; return; }

    pageData.forEach(r=>{
        const siteDisplay = r.site.length>50?r.site.substring(0,47)+'...':r.site;
        const dateDisplay = r.date ? r.date.substring(0,10) : '-';
        const imgPath = getGitHubImagePath(r.screenshot);
        const screenshotCell = `<img src="${imgPath}" alt="Screenshot" class="screenshot-thumbnail" onclick="event.stopPropagation(); showImage('${imgPath}')" onerror="this.style.display='none'">`;

        tbody.innerHTML+=`<tr>
            <td title="${r.site}">${siteDisplay}</td>
            <td>${dateDisplay}</td>
            <td>${r.sector}</td>
            <td>${r.goal}</td>
            <td class="screenshot-cell">${screenshotCell}</td>
        </tr>`;
    });

    const total = Math.ceil(data.length/rowsPerPage)||1;
    document.getElementById('pageInfo').textContent=`Page ${page} of ${total} (${data.length} records)`;
    document.getElementById('prevBtn').disabled=page===1;
    document.getElementById('nextBtn').disabled=page===total;
}

// (Qui puoi riutilizzare il tuo codice dei grafici e PDF, aggiornandolo per leggere `r.screenshot` invece di rowIndex)
</script>
</body>
</html>
