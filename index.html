<script>
/* =======================
   GLOBAL STATE
======================= */
let allSectorsChart, top5SectorsBarChart, goalsPieChart, monthChart, goalsByMonthChart;
let currentData = [];
let filteredData = [];
let currentPage = 1;
const rowsPerPage = 10;

const colors = [
    '#5a8db8','#e74c3c','#e67e22','#7b8794','#3498db',
    '#9b59b6','#27ae60','#f39c12','#c0392b','#16a085'
];

/* =======================
   FILE UPLOAD
======================= */
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const fileInfo = document.getElementById('fileInfo');
const errorMsg = document.getElementById('errorMsg');

uploadArea.onclick = () => fileInput.click();

uploadArea.addEventListener('dragover', e => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', e => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
});

fileInput.addEventListener('change', e => {
    if (e.target.files[0]) handleFile(e.target.files[0]);
});

/* =======================
   CSV PARSER
======================= */
function handleFile(file) {
    errorMsg.textContent = '';
    fileInfo.textContent = `ðŸ“ Loading ${file.name}...`;

    const reader = new FileReader();
    reader.onload = e => {
        try {
            const text = e.target.result;
            const lines = text.split('\n').filter(l => l.trim());
            if (lines.length < 2) throw new Error('CSV empty');

            const delimiter = lines[0].includes('\t') ? '\t' : ',';

            const parseLine = line => {
                const out = [];
                let cur = '', q = false;
                for (let i=0;i<line.length;i++) {
                    const c=line[i];
                    if (c === '"') q = !q;
                    else if (c === delimiter && !q) {
                        out.push(cur.trim()); cur='';
                    } else cur+=c;
                }
                out.push(cur.trim());
                return out;
            };

            const headers = parseLine(lines[0]).map(h => h.toLowerCase());
            const idx = {
                site: headers.findIndex(h=>h.includes('site')||h.includes('url')),
                date: headers.findIndex(h=>h.includes('date')||h.includes('seen')),
                sector: headers.findIndex(h=>h.includes('sector')),
                goal: headers.findIndex(h=>h.includes('goal')),
                screenshot: headers.findIndex(h=>h.includes('screenshot')||h.includes('image'))
            };

            if (idx.site<0||idx.sector<0||idx.goal<0)
                throw new Error('Required columns missing');

            currentData = lines.slice(1).map(l=>{
                const v=parseLine(l);
                return {
                    site:v[idx.site]||'',
                    date:idx.date>-1?v[idx.date]:'',
                    sector:(v[idx.sector]||'UNKNOWN').toUpperCase(),
                    goal:(v[idx.goal]||'UNKNOWN').toUpperCase(),
                    screenshot:idx.screenshot>-1?v[idx.screenshot]:''
                };
            }).filter(r=>r.site);

            filteredData = currentData;
            fileInfo.textContent = `âœ“ Loaded ${currentData.length} records`;

            document.getElementById('tableContainer').classList.add('active');
            populateFilters(currentData);
            applyFilters();

        } catch(err) {
            errorMsg.textContent = `âš ï¸ ${err.message}`;
        }
    };
    reader.readAsText(file);
}

/* =======================
   FILTERS
======================= */
['dateStartFilter','dateEndFilter','sectorFilter','goalFilter']
.forEach(id => document.getElementById(id).addEventListener('change', applyFilters));

document.getElementById('resetFiltersBtn').onclick = () => {
    ['dateStartFilter','dateEndFilter','sectorFilter','goalFilter']
    .forEach(id => document.getElementById(id).value='');
    applyFilters();
};

function populateFilters(data){
    const sectorSel = document.getElementById('sectorFilter');
    const goalSel = document.getElementById('goalFilter');
    sectorSel.innerHTML='<option value="">All Sectors</option>';
    goalSel.innerHTML='<option value="">All Goals</option>';

    [...new Set(data.map(d=>d.sector))].sort()
        .forEach(s=>sectorSel.innerHTML+=`<option>${s}</option>`);

    [...new Set(data.map(d=>d.goal))].sort()
        .forEach(g=>goalSel.innerHTML+=`<option>${g}</option>`);
}

function applyFilters(){
    const ds=document.getElementById('dateStartFilter').value;
    const de=document.getElementById('dateEndFilter').value;
    const s=document.getElementById('sectorFilter').value;
    const g=document.getElementById('goalFilter').value;

    filteredData=currentData.filter(r=>{
        if(ds && r.date<ds) return false;
        if(de && r.date>de) return false;
        if(s && r.sector!==s) return false;
        if(g && r.goal!==g) return false;
        return true;
    });

    displayPage(1);
    updateAllCharts(filteredData);
}

/* =======================
   TABLE + PAGINATION
======================= */
document.getElementById('prevBtn').onclick=()=>currentPage>1&&displayPage(currentPage-1);
document.getElementById('nextBtn').onclick=()=>{
    const t=Math.ceil(filteredData.length/rowsPerPage);
    currentPage<t&&displayPage(currentPage+1);
};

function displayPage(p){
    currentPage=p;
    const tbody=document.getElementById('tableBody');
    tbody.innerHTML='';
    const slice=filteredData.slice((p-1)*rowsPerPage,p*rowsPerPage);

    if(!slice.length){
        tbody.innerHTML='<tr><td colspan="5">No data</td></tr>';
        return;
    }

    slice.forEach(r=>{
        tbody.innerHTML+=`
        <tr>
            <td>${r.site}</td>
            <td>${r.date?.slice(0,10)||'-'}</td>
            <td>${r.sector}</td>
            <td>${r.goal}</td>
            <td>${r.screenshot||'-'}</td>
        </tr>`;
    });

    const total=Math.max(1,Math.ceil(filteredData.length/rowsPerPage));
    document.getElementById('pageInfo').textContent=
        `Page ${p} of ${total} (${filteredData.length})`;
}

/* =======================
   CHARTS
======================= */
function updateAllCharts(data){
    updateMonthChart(data);
    updateGoalsByMonthChart(data);
}

function updateMonthChart(data){
    if(monthChart) monthChart.destroy();
    const m={};
    data.forEach(r=>{
        if(r.date?.length>=7){
            const k=r.date.slice(0,7);
            m[k]=(m[k]||0)+1;
        }
    });

    const months=Object.keys(m).sort();
    const monthNames=['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
    const labels=months.map(x=>{
        const[y,mm]=x.split('-');
        return `${monthNames[mm-1]} ${y}`;
    });

    monthChart=new Chart(monthChartCanvas,{
        type:'line',
        data:{labels,datasets:[{
            data:months.map(x=>m[x]),
            borderColor:'#2962FF',
            tension:.3,
            fill:true
        }]},
        options:{responsive:true,maintainAspectRatio:false}
    });
}

function updateGoalsByMonthChart(data){
    if(goalsByMonthChart) goalsByMonthChart.destroy();

    const map={}, count={};
    data.forEach(r=>{
        if(r.date?.length>=7){
            const m=r.date.slice(0,7);
            map[m]=map[m]||{};
            map[m][r.goal]=(map[m][r.goal]||0)+1;
            count[r.goal]=(count[r.goal]||0)+1;
        }
    });

    const months=Object.keys(map).sort();
    const topGoals=Object.entries(count)
        .sort((a,b)=>b[1]-a[1]).slice(0,5).map(x=>x[0]);

    const labels=months.map(m=>{
        const[y,mm]=m.split('-');
        return `${['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'][mm-1]} ${y}`;
    });

    goalsByMonthChart=new Chart(goalsByMonthChartCanvas,{
        type:'line',
        data:{
            labels,
            datasets:topGoals.map((g,i)=>({
                label:g,
                data:months.map(m=>map[m][g]||0),
                borderColor:colors[i],
                tension:.4
            }))
        },
        options:{responsive:true,maintainAspectRatio:false}
    });
}

document.getElementById('generatePdfBtn').onclick=()=>{
    alert('PDF generation coming soon');
};
</script>
