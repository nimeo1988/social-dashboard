<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Attacchi</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
body{margin:0;font-family:sans-serif;background:#1a1d2e;color:#e8e9ed;}
.container{max-width:1200px;margin:0 auto;padding:20px;}
#uploadArea{border:2px dashed #4a5568;padding:40px;text-align:center;border-radius:8px;cursor:pointer;margin-bottom:20px;background:#2d3142;transition:0.3s;}
#uploadArea.dragover,#uploadArea:hover{border-color:#5a8db8;background:rgba(90,141,184,.1);}
#fileInput{display:none;}
#fileInfo{color:#27ae60;margin:10px 0;}
#errorMsg{color:#e74c3c;margin:10px 0;}
table{width:100%;border-collapse:collapse;margin-top:20px;font-size:12px;}
th,td{padding:8px;border-bottom:1px solid #2d3142;}
th{background:#252837;color:#a0a4b8;text-transform:uppercase;}
tr:hover{background:rgba(90,141,184,.05);}
.pagination{display:flex;justify-content:center;gap:10px;margin:10px 0;}
button{padding:5px 10px;cursor:pointer;border:none;border-radius:4px;background:#5a8db8;color:#fff;}
button:hover{background:#4a7da8;}
.filter-section{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;}
input,select{padding:5px;border-radius:4px;background:#2d3142;color:#e8e9ed;border:1px solid #3d4152;}
.charts-grid{display:flex;flex-direction:column;gap:20px;margin-top:20px;}
.charts-row-horizontal{display:flex;flex-direction:column;gap:20px;}
@media(min-width:768px){
  .charts-row-horizontal{flex-direction:row;}
  .chart-container{width:48%;}
}
.chart-container{width:100%;height:300px;background:#252837;padding:15px;border-radius:8px;}
</style>
</head>
<body>
<div class="container">

<!-- UPLOAD -->
<div id="uploadArea">
<p>üìÇ Drag & Drop CSV here or click to select</p>
</div>
<input type="file" id="fileInput" accept=".csv,.tsv,.txt">
<div id="fileInfo"></div>
<div id="errorMsg"></div>

<!-- FILTRI -->
<div class="filter-section">
<input type="date" id="dateStartFilter">
<input type="date" id="dateEndFilter">
<select id="sectorFilter"><option value="">All Sectors</option></select>
<select id="goalFilter"><option value="">All Goals</option></select>
<button id="resetFiltersBtn">Reset Filters</button>
</div>

<!-- TABELLA -->
<table>
<thead>
<tr><th>#</th><th>Site</th><th>Date</th><th>Sector</th><th>Goal</th></tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
<div class="pagination">
<button id="prevBtn">‚Üê Prev</button>
<span id="pageInfo">Page 1</span>
<button id="nextBtn">Next ‚Üí</button>
</div>

<!-- GRAFICI -->
<div class="charts-grid">
  <!-- 1. Distribuzione Settore -->
  <div class="chart-container"><canvas id="allSectorsChart"></canvas></div>
  <!-- 2. Top 5 Settori -->
  <div class="chart-container"><canvas id="top5SectorsBarChart"></canvas></div>
  <!-- 3. Distribuzione Obiettivi -->
  <div class="chart-container"><canvas id="goalsPieChart"></canvas></div>
  <!-- 4 + 5. Attacchi per mese + obiettivi nel tempo -->
  <div class="charts-row-horizontal">
    <div class="chart-container"><canvas id="monthChart"></canvas></div>
    <div class="chart-container"><canvas id="goalsByMonthChart"></canvas></div>
  </div>
</div>

<script>
// =======================
// VARIABILI GLOBALI
// =======================
let allSectorsChart, top5SectorsBarChart, goalsPieChart, monthChart, goalsByMonthChart;
let currentData=[], filteredData=[], currentPage=1, rowsPerPage=10;
const colors=['#5a8db8','#e74c3c','#e67e22','#7b8794','#3498db','#9b59b6','#27ae60','#f39c12','#c0392b','#16a085','#8e44ad','#2c3e50','#95a5a6','#34495e'];

// =======================
// DOM ELEMENTS
// =======================
const uploadArea=document.getElementById('uploadArea');
const fileInput=document.getElementById('fileInput');
const fileInfo=document.getElementById('fileInfo');
const errorMsg=document.getElementById('errorMsg');
const allSectorsChartEl=document.getElementById('allSectorsChart');
const top5SectorsBarChartEl=document.getElementById('top5SectorsBarChart');
const goalsPieChartEl=document.getElementById('goalsPieChart');
const monthChartEl=document.getElementById('monthChart');
const goalsByMonthChartEl=document.getElementById('goalsByMonthChart');
const tableBody=document.getElementById('tableBody');
const pageInfo=document.getElementById('pageInfo');
const dateStartFilter=document.getElementById('dateStartFilter');
const dateEndFilter=document.getElementById('dateEndFilter');
const sectorFilter=document.getElementById('sectorFilter');
const goalFilter=document.getElementById('goalFilter');
const resetFiltersBtn=document.getElementById('resetFiltersBtn');

// =======================
// UPLOAD CSV
// =======================
uploadArea.addEventListener('click',()=>fileInput.click());
uploadArea.addEventListener('dragover',e=>{e.preventDefault();uploadArea.classList.add('dragover');});
uploadArea.addEventListener('dragleave',()=>uploadArea.classList.remove('dragover'));
uploadArea.addEventListener('drop',e=>{e.preventDefault();uploadArea.classList.remove('dragover');handleFile(e.dataTransfer.files[0]);});
fileInput.addEventListener('change',e=>handleFile(e.target.files[0]));

function handleFile(file){
if(!file) return;
errorMsg.textContent=''; fileInfo.textContent=`Loading ${file.name}...`;
const reader=new FileReader();
reader.onload=e=>{
  try{
    const lines=e.target.result.split(/\r?\n/).filter(l=>l.trim());
    if(lines.length===0) throw new Error('CSV vuoto');
    const delimiter=lines[0].includes('\t')?'\t':',';
    const headers=lines[0].split(delimiter).map(h=>h.trim().toLowerCase());
    const siteIdx=headers.findIndex(h=>h.includes('site')||h.includes('url'));
    const dateIdx=headers.findIndex(h=>h.includes('last seen'));
    const sectorIdx=headers.findIndex(h=>h.includes('sector attacked'));
    const goalIdx=headers.findIndex(h=>h.includes('attack goal'));
    if(siteIdx===-1||sectorIdx===-1||goalIdx===-1){errorMsg.textContent='CSV columns not valid';return;}
    currentData=lines.slice(1).map(l=>{
      const v=l.split(delimiter).map(x=>x.trim());
      let date='';
      if(v[dateIdx]){const p=v[dateIdx].split(' ')[0].split('/'); if(p.length===3) date=`${p[2]}-${p[1]}-${p[0]}`;}
      return {site:v[siteIdx]||'',date,sector:(v[sectorIdx]||'').toUpperCase(),goal:(v[goalIdx]||'').toUpperCase()};
    });
    filteredData=currentData;
    fileInfo.textContent=`Loaded ${currentData.length} rows`;
    populateFilters(); displayPage(filteredData,1); updateAllCharts(filteredData);
  }catch(err){console.error(err);errorMsg.textContent='Error reading CSV';}
};
reader.readAsText(file);
}

// =======================
// TABLE & PAGINATION
// =======================
function displayPage(data,page){currentPage=page;const start=(page-1)*rowsPerPage;const pageData=data.slice(start,start+rowsPerPage);tableBody.innerHTML='';pageData.forEach((r,i)=>tableBody.innerHTML+=`<tr><td>${start+i+1}</td><td>${r.site}</td><td>${r.date}</td><td>${r.sector}</td><td>${r.goal}</td></tr>`);pageInfo.textContent=`Page ${currentPage}`;}
document.getElementById('prevBtn').addEventListener('click',()=>{if(currentPage>1) displayPage(filteredData,currentPage-1);});
document.getElementById('nextBtn').addEventListener('click',()=>{if(currentPage*rowsPerPage<filteredData.length) displayPage(filteredData,currentPage+1);});

// =======================
// FILTERS
// =======================
function populateFilters(){
const sectors=[...new Set(currentData.map(d=>d.sector))].sort();
const goals=[...new Set(currentData.map(d=>d.goal))].sort();
sectorFilter.innerHTML='<option value="">All Sectors</option>'+sectors.map(s=>`<option>${s}</option>`).join('');
goalFilter.innerHTML='<option value="">All Goals</option>'+goals.map(g=>`<option>${g}</option>`).join('');
}
dateStartFilter.addEventListener('change',applyFilters);
dateEndFilter.addEventListener('change',applyFilters);
sectorFilter.addEventListener('change',applyFilters);
goalFilter.addEventListener('change',applyFilters);
resetFiltersBtn.addEventListener('click',()=>{dateStartFilter.value='';dateEndFilter.value='';sectorFilter.value='';goalFilter.value='';applyFilters();});
function applyFilters(){filteredData=currentData.filter(d=>{if(dateStartFilter.value&&d.date<dateStartFilter.value) return false;if(dateEndFilter.value&&d.date>dateEndFilter.value) return false;if(sectorFilter.value&&d.sector!==sectorFilter.value) return false;if(goalFilter.value&&d.goal!==goalFilter.value) return false;return true;});displayPage(filteredData,1);updateAllCharts(filteredData);}

// =======================
// CHARTS
// =======================
function baseOptions(showLegend=false){return{responsive:true,maintainAspectRatio:false,elements:{point:{radius:0,hoverRadius:4}},scales:{x:{ticks:{autoSkip:true,maxTicksLimit:6,color:'#a0a4b8'},grid:{color:'#2d3142'}},y:{beginAtZero:true,ticks:{color:'#a0a4b8'},grid:{color:'#2d3142'}}},plugins:{legend:showLegend?{position:'bottom',labels:{color:'#c5c7d0',boxWidth:10}}:{display:false}}};}

function updateSectorsPieChart(data){const c={};data.forEach(r=>c[r.sector]=(c[r.sector]||0)+1);if(allSectorsChart) allSectorsChart.destroy();allSectorsChart=new Chart(allSectorsChartEl,{type:'doughnut',data:{labels:Object.keys(c),datasets:[{data:Object.values(c),backgroundColor:colors}]},options:baseOptions(true)});}
function updateTop5SectorsBarChart(data){const c={};data.forEach(r=>c[r.sector]=(c[r.sector]||0)+1);const s=Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,5);if(top5SectorsBarChart) top5SectorsBarChart.destroy();top5SectorsBarChart=new Chart(top5SectorsBarChartEl,{type:'bar',data:{labels:s.map(x=>x[0]),datasets:[{data:s.map(x=>x[1]),backgroundColor:colors}]},options:{responsive:true,plugins:{legend:{display:false}}}});}
function updateGoalsPieChart(data){const c={};data.forEach(r=>c[r.goal]=(c[r.goal]||0)+1);if(goalsPieChart) goalsPieChart.destroy();goalsPieChart=new Chart(goalsPieChartEl,{type:'doughnut',data:{labels:Object.keys(c),datasets:[{data:Object.values(c),backgroundColor:colors}]},options:baseOptions(true)});}
function updateMonthChart(data){const m={};data.forEach(r=>{if(r.date){const k=r.date.substring(0,7);m[k]=(m[k]||0)+1;}});const labels=Object.keys(m).sort();if(monthChart) monthChart.destroy();monthChart=new Chart(monthChartEl,{type:'line',data:{labels,datasets:[{data:labels.map(l=>m[l]),borderColor:'#5a8db8',backgroundColor:'rgba(90,141,184,.15)',fill:true,tension:.4,borderWidth:2}]},options:baseOptions(false)});}
function updateGoalsByMonthChart(data){const map={},goals=new Set();data.forEach(r=>{if(r.date){const m=r.date.substring(0,7);if(!map[m]) map[m]={};map[m][r.goal]=(map[m][r.goal]||0)+1;goals.add(r.goal);}});const months=Object.keys(map).sort();const datasets=[...goals].map((g,i)=>({label:g,data:months.map(m=>map[m][g]||0),borderColor:colors[i%colors.length],tension:.4,borderWidth:2,fill:false}));if(goalsByMonthChart) goalsByMonthChart.destroy();goalsByMonthChart=new Chart(goalsByMonthChartEl,{type:'line',data:{labels:months,datasets},options:baseOptions(true)});}
function updateAllCharts(data){updateSectorsPieChart(data);updateTop5SectorsBarChart(data);updateGoalsPieChart(data);updateMonthChart(data);updateGoalsByMonthChart(data);}
</script>
</body>
</html>
