<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Social Engineering Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Roboto+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
/* ========================================
   SOCIAL ENGINEERING DASHBOARD - CSS COMPLETO
======================================== */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: 'Rajdhani', sans-serif; 
    background: linear-gradient(135deg, #0a0e27 0%, #1a1d35 50%, #0f1128 100%); 
    color: #e0e6ed; 
    min-height: 100vh; 
    padding: 2rem; 
}
.container { max-width: 1600px; margin: 0 auto; }
header { text-align: center; margin-bottom: 3rem; }
h1 { font-size: 2.8rem; font-weight: 700; letter-spacing: 6px; text-transform: uppercase; color: #fff; margin-bottom: .5rem; }
.subtitle { font-size: 1.1rem; color: #8b95a5; letter-spacing: 2px; }
.upload-section { background: rgba(20,25,45,.8); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(58,69,86,.5); box-shadow: 0 8px 32px rgba(0,0,0,.3); text-align: center; }
.upload-area { border: 2px dashed #5a8db8; border-radius: 8px; padding: 3rem 2rem; margin: 1rem 0; cursor: pointer; transition: all .3s ease; background: rgba(90,141,184,.05); }
.upload-area:hover { border-color: #63b3ed; background: rgba(90,141,184,.1); transform: translateY(-2px); }
.upload-area.dragover { border-color: #27ae60; background: rgba(39,174,96,.15); }
.upload-icon { font-size: 3rem; margin-bottom: 1rem; color: #5a8db8; }
.file-input { display: none; }
.upload-btn { padding: 1rem 2rem; background: #5a8db8; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-family: 'Rajdhani', sans-serif; font-weight: 600; letter-spacing: 1px; transition: all .3s ease; }
.upload-btn:hover { background: #4a7da8; transform: translateY(-2px); }
.file-info { margin-top: 1rem; color: #27ae60; font-family: 'Roboto Mono', monospace; font-size: .9rem; }
.error-msg { margin-top: 1rem; color: #e74c3c; font-family: 'Roboto Mono', monospace; font-size: .9rem; }
.table-container { background: rgba(20,25,45,.8); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(58,69,86,.5); box-shadow: 0 8px 32px rgba(0,0,0,.3); overflow-x: auto; display: none; }
.table-container.active { display: block; animation: slideIn 0.5s ease; }
@keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
.search-box { width: 100%; padding: .9rem; margin-bottom: 1.2rem; border-radius: 6px; border: 1px solid #3a4556; background: rgba(15,18,35,.9); color: #e0e6ed; font-family: 'Roboto Mono', monospace; font-size: .9rem; transition: border-color .3s; }
.search-box:focus { outline: none; border-color: #2962ff; }
.pagination { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1.5rem; }
.pagination button { padding: .7rem 1.5rem; background: #5a8db8; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-family: 'Rajdhani', sans-serif; font-weight: 600; transition: all .3s ease; }
.pagination button:hover:not(:disabled) { background: #4a7da8; }
.pagination button:disabled { opacity: .5; cursor: not-allowed; }
table { width: 100%; border-collapse: collapse; }
thead { background: #1e2538; }
th { padding: 1.2rem; text-align: left; text-transform: uppercase; color: #a8b2c1; font-size: .9rem; }
td { padding: 1.2rem; border-bottom: 1px solid rgba(58,69,86,.3); font-family: 'Roboto Mono', monospace; font-size: .85rem; }
tbody tr:hover { background: rgba(99,179,237,.08); }
.screenshot-cell { text-align: center; }
.screenshot-thumbnail { width: 80px; height: 60px; object-fit: cover; border-radius: 5px; cursor: pointer; transition: transform .3s; border: 2px solid #3a4556; }
.screenshot-thumbnail:hover { transform: scale(1.1); border-color: #5a8db8; }
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,.9); justify-content: center; align-items: center; }
.modal-content { max-width: 90%; max-height: 90%; border-radius: 10px; }
.close { position: absolute; top: 20px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; }
.close:hover { color: #bbb; }
.charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem; display: none; }
.charts-grid.active { display: grid; }
.charts-grid-single { display: grid; grid-template-columns: 1fr; gap: 2rem; margin-top: 2rem; display: none; max-width: 800px; margin-left: auto; margin-right: auto; }
.charts-grid-single.active { display: grid; }
.chart-card { background: rgba(20,25,45,.8); border-radius: 12px; padding: 2rem; border: 1px solid rgba(58,69,86,.5); }
.chart-card h3 { margin-bottom: 1rem; color: #fff; font-size: 1.2rem; letter-spacing: 1px; }
.chart-wrapper { height: 400px; background: linear-gradient(135deg, #1a1d35 0%, #22253a 100%) !important; border-radius: 8px; padding: 15px; }
.chartjs-render-monitor { background: #1a1d35 !important; }
@media (max-width: 1200px) { .charts-grid { grid-template-columns: 1fr; } }
@media (max-width: 768px) { body { padding: 1rem; } h1 { font-size: 2rem; } .chart-wrapper { height: 300px; } }
</style>
</head>
<body>
<div class="container">
<header>
<h1>SOCIAL ENGINEERING DASHBOARD</h1>
<div class="subtitle">Phishing Sites ‚Ä¢ Human Attack Surface</div>
</header>

<div class="upload-section">
<h2 style="margin-bottom:1rem;color:#fff;letter-spacing:2px;font-size:1.3rem;">UPLOAD CSV DATA</h2>
<div class="upload-area" id="uploadArea">
<div class="upload-icon">üìä</div>
<p style="font-size:1.1rem;margin-bottom:.5rem">Click to upload CSV file</p>
<p style="color:#8b95a5;margin-bottom:1rem">or drag & drop here</p>
<input type="file" id="fileInput" class="file-input" accept=".csv,.tsv,.txt">
</div>
<div id="fileInfo" class="file-info"></div>
<div id="errorMsg" class="error-msg"></div>
</div>

<div class="table-container" id="tableContainer">
<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr 120px;gap:1rem;margin-bottom:1.5rem;">
<div class="date-input-wrapper"><input type="date" id="dateStartFilter" class="search-box" placeholder="Start Date"><span class="date-tooltip">üìÖ Inizio</span></div>
<div class="date-input-wrapper"><input type="date" id="dateEndFilter" class="search-box" placeholder="End Date"><span class="date-tooltip">üìÖ Fine</span></div>
<select id="sectorFilter" class="search-box"><option value="">Tutti i Settori</option></select>
<select id="goalFilter" class="search-box"><option value="">Tutti gli Obiettivi</option></select>
<button id="resetFiltersBtn" class="upload-btn" style="background:#e74c3c;padding:.9rem 1rem;font-size:.9rem;">üîÑ Reset</button>
</div>
<div style="text-align:center;margin-bottom:1.5rem;">
<button id="generatePdfBtn" class="upload-btn" style="background:#27ae60;">üìÑ PDF Report</button>
</div>
<table>
<thead>
<tr><th>Site</th><th>Data</th><th>Settore Attaccato</th><th>Obiettivo Attacco</th><th>Screenshot</th></tr>
</thead>
<tbody id="tableBody">
<tr><td colspan="5" style="text-align:center;color:#8b95a5;padding:3rem;">Carica un file CSV per iniziare</td></tr>
</tbody>
</table>
<div class="pagination">
<button id="prevBtn">‚Üê Prev</button>
<span id="pageInfo">Pagina 1</span>
<button id="nextBtn">Next ‚Üí</button>
</div>
</div>

<div class="charts-grid" id="chartsGridSectors">
<div class="chart-card">
<h3>üìä Distribuzione Settori</h3>
<div class="chart-wrapper"><canvas id="allSectorsChart"></canvas></div>
</div>
<div class="chart-card">
<h3>üèÜ Top 5 Settori</h3>
<div class="chart-wrapper"><canvas id="top5SectorsBarChart"></canvas></div>
</div>
</div>

<div class="charts-grid-single" id="chartsGridGoalsPie">
<div class="chart-card">
<h3>üéØ Distribuzione Obiettivi</h3>
<div class="chart-wrapper"><canvas id="goalsPieChart"></canvas></div>
</div>
</div>

<div class="charts-grid" id="chartsGridMonthAndGoals">
<div class="chart-card">
<h3>üåä Analisi Temporale</h3>
<div class="chart-wrapper"><canvas id="monthChart"></canvas></div>
</div>
<div class="chart-card">
<h3>üìà Evoluzione Obiettivi</h3>
<div class="chart-wrapper"><canvas id="goalsByMonthChart"></canvas></div>
</div>
</div>

<div id="imageModal" class="modal" onclick="closeModal()">
<span class="close" onclick="event.stopPropagation();closeModal()">&times;</span>
<img class="modal-content" id="modalImage">
</div>
</div>

<script>
let allSectorsChart, top5SectorsBarChart, goalsPieChart, monthChart, goalsByMonthChart;
let currentData = [], filteredData = [], currentPage = 1;
const rowsPerPage = 10;
const colors = ['#2962FF','#F44336','#4CAF50','#FF9800','#9C27B0','#00BCD4','#E91E63','#8BC34A','#FFC107','#FF5722','#795548','#607D8B','#CDDC39','#009688','#673AB7'];

const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const fileInfo = document.getElementById('fileInfo');
const errorMsg = document.getElementById('errorMsg');

// Drag & Drop
uploadArea.onclick = () => fileInput.click();
uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
uploadArea.addEventListener('drop', e => { 
    e.preventDefault(); 
    uploadArea.classList.remove('dragover'); 
    const file = e.dataTransfer.files[0]; 
    if(file) handleFile(file); 
});
fileInput.addEventListener('change', e => { const file = e.target.files[0]; if(file) handleFile(file); });

function getLocalImagePath(screenshotName) { 
    return screenshotName && screenshotName.trim() ? `images/${screenshotName.trim()}` : ''; 
}

function showImage(imagePath) { 
    document.getElementById('imageModal').style.display = 'flex'; 
    document.getElementById('modalImage').src = imagePath; 
}

function closeModal() { 
    document.getElementById('imageModal').style.display = 'none'; 
}

function handleFile(file) {
    errorMsg.textContent = ''; 
    fileInfo.textContent = `üìÅ Caricamento ${file.name}...`;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const text = e.target.result;
            const firstLine = text.split('\n')[0];
            const delimiter = (firstLine.match(/\t/g) || []).length > (firstLine.match(/,/g) || []).length ? '\t' : ',';
            const lines = text.split('\n').filter(l => l.trim());
            
            if(lines.length < 2) { 
                errorMsg.textContent = '‚ö†Ô∏è File vuoto o senza dati'; 
                return; 
            }
            
            function parseCSVLine(line, delim) {
                const result = []; let current = ''; let inQuotes = false;
                for(let i = 0; i < line.length; i++) {
                    const char = line[i], nextChar = line[i + 1];
                    if(char === '"') { 
                        if(inQuotes && nextChar === '"') { current += '"'; i++; } 
                        else inQuotes = !inQuotes; 
                    }
                    else if(char === delim && !inQuotes) { 
                        result.push(current.trim()); 
                        current = ''; 
                    }
                    else if(char !== '\r') current += char;
                }
                result.push(current.trim()); 
                return result;
            }
            
            const headers = parseCSVLine(lines[0], delimiter);
            let siteIdx = -1, dateIdx = -1, sectorIdx = -1, goalIdx = -1, screenshotIdx = -1;
            
            headers.forEach((h, i) => {
                const lower = h.toLowerCase().trim();
                if(lower.includes('site') || lower.includes('sito') || lower.includes('url')) siteIdx = i;
                if(lower.includes('date') || lower.includes('data')) dateIdx = i;
                if(lower.includes('sector')) sectorIdx = i;
                if(lower.includes('goal') || lower.includes('obiettivo')) goalIdx = i;
                if(lower.includes('screenshot') || lower.includes('image')) screenshotIdx = i;
            });
            
            if(siteIdx === -1 || sectorIdx === -1 || goalIdx === -1) {
                errorMsg.innerHTML = `‚ö†Ô∏è Colonne mancanti!<br> trovate: ${headers.map((h,i) => `${i}: "${h}"`).join(', ')}`; 
                return;
            }
            
            const data = [];
            for(let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i], delimiter);
                if(values[siteIdx] && values[siteIdx].length > 0) {
                    data.push({
                        site: values[siteIdx] || '',
                        date: dateIdx !== -1 ? values[dateIdx] : '',
                        sector: (values[sectorIdx] || 'UNKNOWN').trim().toUpperCase(),
                        goal: (values[goalIdx] || 'UNKNOWN').trim().toUpperCase(),
                        screenshot: screenshotIdx !== -1 ? values[screenshotIdx] : '',
                        rowIndex: i
                    });
                }
            }
            
            currentData = filteredData = data;
            fileInfo.textContent = `‚úÖ Caricati ${data.length} record`;
            document.getElementById('tableContainer').classList.add('active');
            populateFilters(data); 
            displayPage(data, 1); 
            updateAllCharts(data);
            
        } catch(error) { 
            errorMsg.textContent = '‚ö†Ô∏è Errore: ' + error.message; 
        }
    };
    reader.readAsText(file);
}

// Event Listeners
document.getElementById('dateStartFilter').addEventListener('change', applyFilters);
document.getElementById('dateEndFilter').addEventListener('change', applyFilters);
document.getElementById('sectorFilter').addEventListener('change', applyFilters);
document.getElementById('goalFilter').addEventListener('change', applyFilters);
document.getElementById('resetFiltersBtn').addEventListener('click', () => {
    document.getElementById('dateStartFilter').value = '';
    document.getElementById('dateEndFilter').value = '';
    document.getElementById('sectorFilter').value = '';
    document.getElementById('goalFilter').value = '';
    applyFilters();
});

function applyFilters() {
    const dateStart = document.getElementById('dateStartFilter').value;
    const dateEnd = document.getElementById('dateEndFilter').value;
    const sectorFilter = document.getElementById('sectorFilter').value;
    const goalFilter = document.getElementById('goalFilter').value;
    
    filteredData = currentData.filter(r => {
        if(dateStart && r.date < dateStart) return false;
        if(dateEnd && r.date > dateEnd) return false;
        if(sectorFilter && r.sector !== sectorFilter) return false;
        if(goalFilter && r.goal !== goalFilter) return false;
        return true;
    });
    displayPage(filteredData, 1);
    updateAllCharts(filteredData);
}

function populateFilters(data) {
    const sectors = [...new Set(data.map(r => r.sector))].sort();
    const goals = [...new Set(data.map(r => r.goal))].sort();
    document.getElementById('sectorFilter').innerHTML = '<option value="">Tutti i Settori</option>' + sectors.map(s => `<option value="${s}">${s}</option>`).join('');
    document.getElementById('goalFilter').innerHTML = '<option value="">Tutti gli Obiettivi</option>' + goals.map(g => `<option value="${g}">${g}</option>`).join('');
}

document.getElementById('prevBtn').onclick = () => { if(currentPage > 1) { currentPage--; displayPage(filteredData, currentPage); } };
document.getElementById('nextBtn').onclick = () => { const total = Math.ceil(filteredData.length / rowsPerPage); if(currentPage < total) { currentPage++; displayPage(filteredData, currentPage); } };

function displayPage(data, page) {
    currentPage = page;
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    const start = (page - 1) * rowsPerPage;
    const pageData = data.slice(start, start + rowsPerPage);
    
    if(pageData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#8b95a5;padding:3rem;">Nessun dato trovato</td></tr>'; 
        return;
    }
    
    pageData.forEach(r => {
        const siteDisplay = r.site.length > 50 ? r.site.substring(0,47) + '...' : r.site;
        const dateDisplay = r.date ? r.date.substring(0,10) : '-';
        const imagePath = getLocalImagePath(r.screenshot);
        const screenshotCell = imagePath ? `<img src="${imagePath}" alt="Screenshot" class="screenshot-thumbnail" onclick="event.stopPropagation(); showImage('${imagePath}')" onerror="this.style.display='none';this.textContent='‚ùå'">` : '‚ùå';
        tbody.innerHTML += `<tr><td title="${r.site}">${siteDisplay}</td><td>${dateDisplay}</td><td>${r.sector}</td><td>${r.goal}</td><td class="screenshot-cell">${screenshotCell}</td></tr>`;
    });
    
    const total = Math.ceil(data.length / rowsPerPage) || 1;
    document.getElementById('pageInfo').textContent = `Pagina ${page} di ${total} (${data.length} record)`;
    document.getElementById('prevBtn').disabled = page === 1;
    document.getElementById('nextBtn').disabled = page === total;
}

function updateAllCharts(data) {
    // Sector charts
    if(!document.getElementById('sectorFilter').value) {
        document.getElementById('chartsGridSectors').classList.add('active');
        updateAllSectorsChart(data); 
        updateTop5SectorsBarChart(data);
    } else {
        document.getElementById('chartsGridSectors').classList.remove('active');
        if(allSectorsChart) allSectorsChart.destroy();
        if(top5SectorsBarChart) top5SectorsBarChart.destroy();
    }
    
    // Goals pie
    if(!document.getElementById('goalFilter').value) {
        document.getElementById('chartsGridGoalsPie').classList.add('active');
        updateGoalsPieChart(data);
    } else {
        document.getElementById('chartsGridGoalsPie').classList.remove('active');
        if(goalsPieChart) goalsPieChart.destroy();
    }
    
    // Month charts - SEMPRE VISIBILI
    document.getElementById('chartsGridMonthAndGoals').classList.add('active');
    updateMonthChart(data);
    updateGoalsByMonthChart(data);
}

// ‚úÖ GRAFICI CORRETTI CON ONDA MARINA üåä
function updateMonthChart(data) {
    if(monthChart) monthChart.destroy();
    const months = {};
    data.forEach(r => { if(r.date && r.date.length >= 7) { const m = r.date.slice(0,7); months[m] = (months[m] || 0) + 1; } });
    const sorted = Object.keys(months).sort();
    const counts = sorted.map(m => months[m]);
    const monthNames = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
    const labels = sorted.map(m => { const [year, month] = m.split('-'); return `${monthNames[parseInt(month)-1]} ${year}`; });

    monthChart = new Chart(document.getElementById('monthChart'), {
        type: 'line',
         {
            labels: labels,
            datasets: [{
                label: 'Campagne',
                 counts,
                borderColor: '#2962FF',
                backgroundColor: 'rgba(41, 98, 255, 0.12)',
                fill: true,
                tension: 0.15,
                borderWidth: 4,
                pointRadius: 0,
                pointHoverRadius: 10,
                pointHoverBackgroundColor: '#2962FF',
                pointHoverBorderColor: '#fff',
                pointHoverBorderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: { 
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    cornerRadius: 8,
                    padding: 15,
                    displayColors: false,
                    callbacks: { label: ctx => `üìà Campagne: ${ctx.parsed.y}` }
                }
            },
            scales: {
                x: { ticks: { color: '#e0e6ed', font: { size: 11, weight: 'bold' } }, grid: { color: 'rgba(224,230,237,0.08)' } },
                y: { beginAtZero: true, ticks: { color: '#e0e6ed', font: { size: 12, weight: 'bold' } }, grid: { color: 'rgba(224,230,237,0.15)' } }
            }
        }
    });
}

function updateGoalsByMonthChart(data) {
    if(goalsByMonthChart) goalsByMonthChart.destroy();
    const monthGoalMap = {}; const allGoals = new Set();
    data.forEach(r => { 
        if(r.date && r.date.length >= 7 && r.goal) { 
            const month = r.date.slice(0,7); 
            allGoals.add(r.goal); 
            if(!monthGoalMap[month]) monthGoalMap[month] = {}; 
            monthGoalMap[month][r.goal] = (monthGoalMap[month][r.goal] || 0) + 1; 
        } 
    });
    const sortedMonths = Object.keys(monthGoalMap).sort();
    const goalCounts = {}; 
    data.forEach(r => { if(r.goal) goalCounts[r.goal] = (goalCounts[r.goal] || 0) + 1; });
    const sortedGoals = Object.entries(goalCounts).sort((a,b) => b[1] - a[1]).slice(0,8).map(([g]) => g);
    const lineColors = ['#2962FF','#F44336','#4CAF50','#FF9800','#9C27B0','#00BCD4','#E91E63','#8BC34A'];
    
    const datasets = sortedGoals.map((goal, idx) => ({
        label: goal.length > 15 ? goal.substring(0,12)+'...' : goal,
         sortedMonths.map(month => monthGoalMap[month]?.[goal] || 0),
        borderColor: lineColors[idx],
        backgroundColor: 'transparent',
        borderWidth: 3.5,
        fill: false,
        tension: 0.12,
        pointRadius: 0,
        pointHoverRadius: 9,
        pointBackgroundColor: lineColors[idx],
        pointBorderColor: '#fff',
        pointBorderWidth: 2.5,
        pointHoverBorderWidth: 3
    }));
    
    const monthNames = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
    const labels = sortedMonths.map(m => { const [year, month] = m.split('-'); return `${monthNames[parseInt(month)-1]} ${year}`; });
    
    goalsByMonthChart = new Chart(document.getElementById('goalsByMonthChart'), {
        type: 'line',
         { labels, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'bottom', labels: { color: '#e0e6ed', font: { size: 11 }, padding: 12 } },
                tooltip: { backgroundColor: 'rgba(0,0,0,0.9)', titleColor: '#fff', bodyColor: '#fff', cornerRadius: 8 }
            },
            scales: {
                x: { ticks: { color: '#e0e6ed', font: { size: 10 } }, grid: { color: 'rgba(224,230,237,0.08)' } },
                y: { beginAtZero: true, ticks: { color: '#e0e6ed', font: { size: 11 } }, grid: { color: 'rgba(224,230,237,0.15)' } }
            }
        }
    });
}

function updateAllSectorsChart(data) {
    if(allSectorsChart) allSectorsChart.destroy();
    const sectors = {}; 
    data.forEach(r => { if(r.sector) sectors[r.sector] = (sectors[r.sector] || 0) + 1; });
    const sorted = Object.entries(sectors).sort((a,b) => b[1] - a[1]);
    
    allSectorsChart = new Chart(document.getElementById('allSectorsChart'), {
        type: 'doughnut',
         { 
            labels: sorted.map(([k]) => k), 
            datasets: [{ 
                 sorted.map(([_,v]) => v), 
                backgroundColor: colors, 
                borderWidth: 3, 
                borderColor: '#1a1d35' 
            }] 
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { color: '#e0e6ed', font: { size: 10 }, padding: 8 } },
                tooltip: { 
                    callbacks: { 
                        label: ctx => { 
                            const total = ctx.dataset.data.reduce((a,b) => a+b,0); 
                            return `${ctx.label}: ${ctx.parsed} (${((ctx.parsed/total)*100).toFixed(1)}%)`; 
                        } 
                    }
                }
            }
        }
    });
}

function updateTop5SectorsBarChart(data) {
    if(top5SectorsBarChart) top5SectorsBarChart.destroy();
    const sectors = {}; 
    data.forEach(r => { if(r.sector) sectors[r.sector] = (sectors[r.sector] || 0) + 1; });
    const sorted = Object.entries(sectors).sort((a,b) => b[1] - a[1]).slice(0,5);
    
    top5SectorsBarChart = new Chart(document.getElementById('top5SectorsBarChart'), {
        type: 'bar',
         { 
            labels: sorted.map(([k]) => k), 
            datasets: [{ 
                label: 'Attacchi', 
                 sorted.map(([_,v]) => v), 
                backgroundColor: ['#2962FF','#F44336','#4CAF50','#FF9800','#9C27B0'], 
                borderWidth: 0, 
                borderRadius: 6 
            }] 
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { color: '#e0e6ed' }, grid: { color: 'rgba(224,230,237,0.1)' } },
                x: { grid: { display: false }, ticks: { color: '#e0e6ed', maxRotation: 45 } }
            }
        }
    });
}

function updateGoalsPieChart(data) {
    if(goalsPieChart) goalsPieChart.destroy();
    const goals = {}; 
    data.forEach(r => { if(r.goal) goals[r.goal] = (goals[r.goal] || 0) + 1; });
    const sorted = Object.entries(goals).sort((a,b) => b[1] - a[1]);
    
    goalsPieChart = new Chart(document.getElementById('goalsPieChart'), {
        type: 'doughnut',
         { 
            labels: sorted.map(([k]) => k), 
            datasets: [{ 
                 sorted.map(([_,v]) => v), 
                backgroundColor: colors, 
                borderWidth: 3, 
                borderColor: '#1a1d35' 
            }] 
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { color: '#e0e6ed', font: { size: 10 }, padding: 8 } },
                tooltip: { 
                    callbacks: { 
                        label: ctx => { 
                            const total = ctx.dataset.data.reduce((a,b) => a+b,0); 
                            return `${ctx.label}: ${ctx.parsed} (${((ctx.parsed/total)*100).toFixed(1)}%)`; 
                        } 
                    }
                }
            }
        }
    });
}

// PDF Report
document.getElementById('generatePdfBtn').addEventListener('click', async () => {
    if(!currentData.length) { 
        alert('‚ö†Ô∏è Nessun dato da esportare!'); 
        return; 
    }
    
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'pt', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    
    // Copertina
    pdf.setFillColor(26,29,53); 
    pdf.rect(0, 0, pageWidth, pdf.internal.pageSize.getHeight(), 'F');
    pdf.setFont('helvetica', 'bold'); 
    pdf.setFontSize(28); 
    pdf.setTextColor(255,255,255);
    pdf.text('SOCIAL ENGINEERING', pageWidth/2, 120, { align: 'center' });
    pdf.setFontSize(20); 
    pdf.text('DASHBOARD REPORT', pageWidth/2, 150, { align: 'center' });
    pdf.setFontSize(12); 
    pdf.setTextColor(139,149,165);
    pdf.text(`Generato: ${new Date().toLocaleDateString('it-IT')} ${new Date().toLocaleTimeString('it-IT')}`, pageWidth/2, 200, { align: 'center' });
    pdf.text(`Totale Record: ${currentData.length}`, pageWidth/2, 220, { align: 'center' });
    
    // Statistiche
    const sectors = {};
    currentData.forEach(r => { if(r.sector) sectors[r.sector] = (sectors[r.sector] || 0) + 1; });
    const totalSectors = Object.keys(sectors).length;
    
    pdf.addPage();
    pdf.setFont('helvetica', 'bold'); 
    pdf.setFontSize(18); 
    pdf.setTextColor(0,0,0);
    pdf.text('STATISTICHE RIASSUNTIVE', 40, 60);
    
    pdf.setFont('helvetica', 'normal'); 
    pdf.setFontSize(12);
    pdf.text(`‚Ä¢ Totale Campagne: ${currentData.length}`, 40, 100);
    pdf.text(`‚Ä¢ Settori Unici: ${totalSectors}`, 40, 120);
    pdf.text(`‚Ä¢ Periodo: ${currentData.length ? new Date(Math.min(...currentData.map(r=>new Date(r.date)))).toLocaleDateString('it-IT') : ''} - ${currentData.length ? new Date(Math.max(...currentData.map(r=>new Date(r.date)))).toLocaleDateString('it-IT') : ''}`, 40, 140);
    
    pdf.save(`phishing-dashboard-${new Date().toISOString().slice(0,10)}.pdf`);
});

// Tooltip date
document.querySelectorAll('.date-input-wrapper').forEach(wrapper => {
    const input = wrapper.querySelector('input');
    input.addEventListener('focus', () => wrapper.classList.add('focused'));
    input.addEventListener('blur', () => wrapper.classList.remove('focused'));
});
</script>
</body>
</html>
